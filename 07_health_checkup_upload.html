<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>健康診断アップロード - 家族健康会議システム</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 375px;
            margin: 0 auto;
            background-color: #f8f9fa;
        }
        .primary-color { color: #4A90E2; }
        .accent-color { color: #50C878; }
        .primary-bg { background-color: #4A90E2; }
        .accent-bg { background-color: #50C878; }
        .tab-active { 
            background-color: #4A90E2; 
            color: white; 
        }
        .tab-inactive { 
            background-color: #e5e7eb; 
            color: #6b7280; 
        }
        .upload-area {
            border: 2px dashed #4A90E2;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background-color: #f8faff;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4A90E2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    
        /* iOS Optimization */
        * {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            -webkit-touch-callout: none;
        }
        
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-overflow-scrolling: touch;
        }
        
        button, a, input, textarea, select {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
    
        :root {
            --primary-color: #4A90E2;
            --accent-color: #50C878;
            --gray-bg: #F8F9FA;
            --gray-border: #E9ECEF;
        }

        /* Footer Navigation */
        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 600px;
            background: white;
            border-top: 1px solid var(--gray-border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 10;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            color: #666;
            text-decoration: none;
            font-size: 12px;
            transition: color 0.2s;
            cursor: pointer;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .create-btn {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: -8px;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
            transition: all 0.3s ease;
        }
        
        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 144, 226, 0.4);
        }
        
        .create-btn i {
            font-size: 24px;
            margin: 0;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm px-4 py-3 flex items-center">
        <button onclick="goBack()" class="mr-3 p-2">
            <i class="fas fa-arrow-left text-xl primary-color"></i>
        </button>
        <h1 class="text-lg font-semibold text-gray-900 flex-1 text-center mr-11">健康診断データをアップロード</h1>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white px-4 py-3">
        <div class="flex rounded-lg overflow-hidden">
            <button id="tab-photo" class="flex-1 py-3 px-2 text-sm font-medium tab-active" onclick="switchTab('photo')">
                <i class="fas fa-camera mr-2"></i>写真撮影
            </button>
            <button id="tab-pdf" class="flex-1 py-3 px-2 text-sm font-medium tab-inactive" onclick="switchTab('pdf')">
                <i class="fas fa-file-pdf mr-2"></i>PDF
            </button>
            <button id="tab-manual" class="flex-1 py-3 px-2 text-sm font-medium tab-inactive" onclick="switchTab('manual')">
                <i class="fas fa-edit mr-2"></i>手動入力
            </button>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="px-4 pb-4">
        <!-- Photo Upload Tab -->
        <div id="content-photo" class="bg-white rounded-lg p-4 shadow-sm">
            <div class="upload-area">
                <i class="fas fa-camera text-4xl primary-color mb-4"></i>
                <p class="text-gray-600 mb-4">健康診断の結果用紙を撮影してください</p>
                <button onclick="takePhoto()" class="primary-bg text-white px-6 py-3 rounded-lg font-medium">
                    <i class="fas fa-camera mr-2"></i>写真を撮る
                </button>
                <input type="file" id="photo-input" accept="image/*" capture="camera" style="display: none;" onchange="handlePhotoUpload(event)">
            </div>
        </div>

        <!-- PDF Upload Tab -->
        <div id="content-pdf" class="bg-white rounded-lg p-4 shadow-sm hidden">
            <div class="upload-area">
                <i class="fas fa-file-pdf text-4xl primary-color mb-4"></i>
                <p class="text-gray-600 mb-2">対応形式: PDF, JPG, PNG</p>
                <p class="text-sm text-gray-500 mb-4">ファイルサイズ: 最大10MB</p>
                <button onclick="selectPDF()" class="primary-bg text-white px-6 py-3 rounded-lg font-medium">
                    <i class="fas fa-upload mr-2"></i>PDFを選択
                </button>
                <input type="file" id="pdf-input" accept=".pdf,.jpg,.jpeg,.png" style="display: none;" onchange="handlePDFUpload(event)">
            </div>
        </div>

        <!-- Manual Input Tab -->
        <div id="content-manual" class="bg-white rounded-lg p-4 shadow-sm hidden">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">体重 (kg)</label>
                    <input type="number" id="weight" placeholder="例: 70" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">血圧（上）</label>
                        <input type="number" id="systolic" placeholder="120" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">血圧（下）</label>
                        <input type="number" id="diastolic" placeholder="80" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">血糖値 (mg/dL)</label>
                    <input type="number" id="glucose" placeholder="例: 95" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">総コレステロール (mg/dL)</label>
                    <input type="number" id="cholesterol" placeholder="例: 180" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">HDL (mg/dL)</label>
                        <input type="number" id="hdl" placeholder="55" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">LDL (mg/dL)</label>
                        <input type="number" id="ldl" placeholder="110" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <button onclick="processManualData()" class="w-full primary-bg text-white py-3 rounded-lg font-medium">
                    <i class="fas fa-check mr-2"></i>データを確認
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Section -->
    <div id="loading-section" class="px-4 pb-4 hidden">
        <div class="bg-white rounded-lg p-6 shadow-sm text-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-gray-600 font-medium">データを解析中...</p>
            <p class="text-sm text-gray-500 mt-2">OCRでテキストを認識しています</p>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-4">
                <div id="progress-bar" class="primary-bg h-2 rounded-full" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Preview Section -->
    <div id="preview-section" class="px-4 pb-4 hidden">
        <div class="bg-white rounded-lg p-4 shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">検出されたデータ</h3>
                <button onclick="editData()" class="text-sm primary-color font-medium">
                    <i class="fas fa-edit mr-1"></i>編集
                </button>
            </div>
            
            <!-- Uploaded Image Preview -->
            <div id="image-preview" class="mb-4 hidden">
                <img id="preview-img" class="w-full h-48 object-cover rounded-lg border">
            </div>
            
            <!-- Data Table -->
            <div class="overflow-hidden border rounded-lg">
                <table class="w-full">
                    <tbody class="bg-white">
                        <tr class="border-b">
                            <td class="px-3 py-2 text-sm font-medium text-gray-700">体重</td>
                            <td class="px-3 py-2 text-sm text-gray-900" id="preview-weight">70kg</td>
                        </tr>
                        <tr class="border-b">
                            <td class="px-3 py-2 text-sm font-medium text-gray-700">血圧</td>
                            <td class="px-3 py-2 text-sm text-gray-900" id="preview-bp">120/80 mmHg</td>
                        </tr>
                        <tr class="border-b">
                            <td class="px-3 py-2 text-sm font-medium text-gray-700">血糖値</td>
                            <td class="px-3 py-2 text-sm text-gray-900" id="preview-glucose">95 mg/dL</td>
                        </tr>
                        <tr class="border-b">
                            <td class="px-3 py-2 text-sm font-medium text-gray-700">総コレステロール</td>
                            <td class="px-3 py-2 text-sm text-gray-900" id="preview-chol">180 mg/dL</td>
                        </tr>
                        <tr class="border-b">
                            <td class="px-3 py-2 text-sm font-medium text-gray-700">HDL</td>
                            <td class="px-3 py-2 text-sm text-gray-900" id="preview-hdl">55 mg/dL</td>
                        </tr>
                        <tr>
                            <td class="px-3 py-2 text-sm font-medium text-gray-700">LDL</td>
                            <td class="px-3 py-2 text-sm text-gray-900" id="preview-ldl">110 mg/dL</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 text-xs text-gray-500 bg-blue-50 p-3 rounded-lg">
                <i class="fas fa-info-circle mr-1"></i>
                データに間違いがある場合は、「編集」ボタンから修正できます。
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="px-4 pb-6">
        <div class="flex space-x-3">
            <button onclick="goBack()" class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg font-medium">
                キャンセル
            </button>
            <button id="confirm-btn" onclick="goToResults()" class="flex-1 primary-bg text-white py-3 rounded-lg font-medium opacity-50 cursor-not-allowed" disabled>
                結果を確認
            </button>
        </div>
    </div>

    <script>
        let currentTab = 'photo';
        let hasData = false;

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.className = btn.className.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`tab-${tab}`).className = 
                document.getElementById(`tab-${tab}`).className.replace('tab-inactive', 'tab-active');

            // Update content
            document.querySelectorAll('[id^="content-"]').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');

            currentTab = tab;
        }

        function takePhoto() {
            document.getElementById('photo-input').click();
        }

        function selectPDF() {
            document.getElementById('pdf-input').click();
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                simulateOCR(file);
            }
        }

        function handlePDFUpload(event) {
            const file = event.target.files[0];
            if (file) {
                simulateOCR(file);
            }
        }

        function processManualData() {
            const weight = document.getElementById('weight').value;
            const systolic = document.getElementById('systolic').value;
            const diastolic = document.getElementById('diastolic').value;
            const glucose = document.getElementById('glucose').value;
            const cholesterol = document.getElementById('cholesterol').value;
            const hdl = document.getElementById('hdl').value;
            const ldl = document.getElementById('ldl').value;

            if (weight || (systolic && diastolic) || glucose || cholesterol) {
                updatePreviewData(weight, systolic, diastolic, glucose, cholesterol, hdl, ldl);
                showPreview();
                enableConfirmButton();
            } else {
                alert('少なくとも1つの項目を入力してください。');
            }
        }

        function simulateOCR(file) {
            // Hide tab content and show loading
            document.querySelectorAll('[id^="content-"]').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById('loading-section').classList.remove('hidden');

            // Simulate OCR progress
            let progress = 0;
            const progressBar = document.getElementById('progress-bar');
            
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15 + 5;
                if (progress > 100) progress = 100;
                progressBar.style.width = progress + '%';

                if (progress >= 100) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        // Hide loading and show preview
                        document.getElementById('loading-section').classList.add('hidden');
                        
                        // Show image preview if it's an image file
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('preview-img').src = e.target.result;
                                document.getElementById('image-preview').classList.remove('hidden');
                            };
                            reader.readAsDataURL(file);
                        }
                        
                        showPreview();
                        enableConfirmButton();
                    }, 500);
                }
            }, 200);
        }

        function updatePreviewData(weight, systolic, diastolic, glucose, cholesterol, hdl, ldl) {
            if (weight) document.getElementById('preview-weight').textContent = weight + 'kg';
            if (systolic && diastolic) document.getElementById('preview-bp').textContent = `${systolic}/${diastolic} mmHg`;
            if (glucose) document.getElementById('preview-glucose').textContent = glucose + ' mg/dL';
            if (cholesterol) document.getElementById('preview-chol').textContent = cholesterol + ' mg/dL';
            if (hdl) document.getElementById('preview-hdl').textContent = hdl + ' mg/dL';
            if (ldl) document.getElementById('preview-ldl').textContent = ldl + ' mg/dL';
        }

        function showPreview() {
            document.getElementById('preview-section').classList.remove('hidden');
            document.getElementById('preview-section').classList.add('fade-in');
            hasData = true;
        }

        function enableConfirmButton() {
            const btn = document.getElementById('confirm-btn');
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.classList.add('hover:bg-blue-600', 'transition-colors');
        }

        function editData() {
            // Switch to manual input tab for editing
            switchTab('manual');
            document.getElementById('preview-section').classList.add('hidden');
            hasData = false;
            
            // Populate form with current preview values
            const weight = document.getElementById('preview-weight').textContent.replace('kg', '');
            const bp = document.getElementById('preview-bp').textContent.split('/');
            const glucose = document.getElementById('preview-glucose').textContent.replace(' mg/dL', '');
            const cholesterol = document.getElementById('preview-chol').textContent.replace(' mg/dL', '');
            const hdl = document.getElementById('preview-hdl').textContent.replace(' mg/dL', '');
            const ldl = document.getElementById('preview-ldl').textContent.replace(' mg/dL', '');

            if (weight && weight !== '70') document.getElementById('weight').value = weight;
            if (bp.length === 2) {
                document.getElementById('systolic').value = bp[0];
                document.getElementById('diastolic').value = bp[1].replace(' mmHg', '');
            }
            if (glucose && glucose !== '95') document.getElementById('glucose').value = glucose;
            if (cholesterol && cholesterol !== '180') document.getElementById('cholesterol').value = cholesterol;
            if (hdl && hdl !== '55') document.getElementById('hdl').value = hdl;
            if (ldl && ldl !== '110') document.getElementById('ldl').value = ldl;
        }

        function goBack() {
            history.back();
        }

        function goToResults() {
            if (hasData) {
                window.location.href = '04_health_checkup_results.html';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            switchTab('photo');
        });
    </script>

    <!-- Footer Navigation -->
    <div class="footer-nav">
        <div class="nav-item" onclick="window.location.href='00_group_timeline.html'">
            <i class="fas fa-home"></i>
            <span>ホーム</span>
        </div>
        <div class="nav-item" onclick="window.location.href='02_my_progress.html'">
            <i class="fas fa-chart-bar"></i>
            <span>進捗</span>
        </div>
        <div class="nav-item">
            <div class="create-btn" onclick="window.open('01_post_creation.html', '_blank')">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        <div class="nav-item" onclick="window.location.href='12_ai_consultation.html'">
            <i class="fas fa-robot"></i>
            <span>AI相談</span>
        </div>
        <div class="nav-item" onclick="window.location.href='13_settings.html'">
            <i class="fas fa-cog"></i>
            <span>メニュー</span>
        </div>
    </div>

</body>
</html>